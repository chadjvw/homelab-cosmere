allowVolumeExpansion: true
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  labels:
    app.kubernetes.io/instance: democratic-csi
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: democratic-csi
    helm.sh/chart: democratic-csi-0.15.0
  name: org.democratic-csi.iscsi
parameters:
  detachedVolumesFromSnapshots: "false"
  fsType: xfs
provisioner: org.democratic-csi.iscsi
reclaimPolicy: Delete
volumeBindingMode: Immediate
---
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    app.kubernetes.io/instance: democratic-csi
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: democratic-csi
    helm.sh/chart: democratic-csi-0.15.0
  name: democratic-csi-controller-sa
  namespace: storage
---
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    app.kubernetes.io/instance: democratic-csi
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: democratic-csi
    helm.sh/chart: democratic-csi-0.15.0
  name: democratic-csi-node-sa
  namespace: storage
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    app.kubernetes.io/instance: democratic-csi
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: democratic-csi
    helm.sh/chart: democratic-csi-0.15.0
  name: democratic-csi-controller-cr
rules:
- apiGroups:
  - apiextensions.k8s.io
  resources:
  - customresourcedefinitions
  verbs:
  - list
  - create
- apiGroups:
  - ""
  resources:
  - persistentvolumes
  verbs:
  - create
  - delete
  - get
  - list
  - watch
  - update
  - patch
- apiGroups:
  - ""
  resources:
  - secrets
  verbs:
  - get
  - list
- apiGroups:
  - ""
  resources:
  - pods
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - ""
  resources:
  - persistentvolumeclaims
  verbs:
  - get
  - list
  - watch
  - update
  - patch
- apiGroups:
  - ""
  resources:
  - persistentvolumeclaims/status
  verbs:
  - get
  - list
  - watch
  - update
  - patch
- apiGroups:
  - ""
  resources:
  - nodes
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - storage.k8s.io
  resources:
  - volumeattachments
  verbs:
  - get
  - list
  - watch
  - update
  - patch
- apiGroups:
  - storage.k8s.io
  resources:
  - volumeattachments/status
  verbs:
  - patch
- apiGroups:
  - storage.k8s.io
  resources:
  - storageclasses
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - csi.storage.k8s.io
  resources:
  - csidrivers
  verbs:
  - get
  - list
  - watch
  - update
  - create
- apiGroups:
  - ""
  resources:
  - events
  verbs:
  - list
  - watch
  - create
  - update
  - patch
- apiGroups:
  - snapshot.storage.k8s.io
  resources:
  - volumesnapshotclasses
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - snapshot.storage.k8s.io
  resources:
  - volumesnapshots/status
  verbs:
  - create
  - get
  - list
  - watch
  - update
  - patch
  - delete
- apiGroups:
  - snapshot.storage.k8s.io
  resources:
  - volumesnapshotcontents
  verbs:
  - create
  - get
  - list
  - watch
  - update
  - patch
  - delete
- apiGroups:
  - snapshot.storage.k8s.io
  resources:
  - volumesnapshotcontents/status
  verbs:
  - create
  - get
  - list
  - watch
  - update
  - patch
  - delete
- apiGroups:
  - snapshot.storage.k8s.io
  resources:
  - volumesnapshots
  verbs:
  - create
  - get
  - list
  - watch
  - update
  - patch
  - delete
- apiGroups:
  - storage.k8s.io
  resources:
  - csinodes
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - csi.storage.k8s.io
  resources:
  - csinodeinfos
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - coordination.k8s.io
  resources:
  - leases
  verbs:
  - get
  - watch
  - list
  - delete
  - update
  - create
- apiGroups:
  - storage.k8s.io
  resources:
  - csistoragecapacities
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
- apiGroups:
  - ""
  resources:
  - pods
  verbs:
  - get
- apiGroups:
  - apps
  resources:
  - daemonsets
  - deployments
  - replicasets
  - statefulsets
  verbs:
  - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    app.kubernetes.io/instance: democratic-csi
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: democratic-csi
    helm.sh/chart: democratic-csi-0.15.0
  name: democratic-csi-node-cr
rules:
- apiGroups:
  - apiextensions.k8s.io
  resources:
  - customresourcedefinitions
  verbs:
  - list
  - create
- apiGroups:
  - ""
  resources:
  - nodes
  verbs:
  - get
  - list
  - watch
  - update
- apiGroups:
  - ""
  resources:
  - persistentvolumes
  verbs:
  - get
  - list
  - watch
  - update
- apiGroups:
  - storage.k8s.io
  resources:
  - volumeattachments
  verbs:
  - get
  - list
  - watch
  - update
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
    app.kubernetes.io/instance: democratic-csi
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: democratic-csi
    helm.sh/chart: democratic-csi-0.15.0
  name: democratic-csi-controller-rb
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: democratic-csi-controller-cr
subjects:
- kind: ServiceAccount
  name: democratic-csi-controller-sa
  namespace: storage
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
    app.kubernetes.io/instance: democratic-csi
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: democratic-csi
    helm.sh/chart: democratic-csi-0.15.0
  name: democratic-csi-node-rb
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: democratic-csi-node-cr
subjects:
- kind: ServiceAccount
  name: democratic-csi-node-sa
  namespace: storage
---
apiVersion: v1
data:
  extra-ca-certs: ""
kind: ConfigMap
metadata:
  labels:
    app.kubernetes.io/instance: democratic-csi
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: democratic-csi
    helm.sh/chart: democratic-csi-0.15.0
  name: democratic-csi
  namespace: storage
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/component: controller-linux
    app.kubernetes.io/csi-role: controller
    app.kubernetes.io/instance: democratic-csi
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: democratic-csi
    helm.sh/chart: democratic-csi-0.15.0
  name: democratic-csi-controller
  namespace: storage
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: controller-linux
      app.kubernetes.io/csi-role: controller
      app.kubernetes.io/instance: democratic-csi
      app.kubernetes.io/managed-by: Helm
      app.kubernetes.io/name: democratic-csi
  template:
    metadata:
      annotations:
        checksum/configmap: 27d5709f6648fe2cbceee9df76c7c94b653208bff8254c4df16fd04c4ca88302
      labels:
        app.kubernetes.io/component: controller-linux
        app.kubernetes.io/csi-role: controller
        app.kubernetes.io/instance: democratic-csi
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/name: democratic-csi
    spec:
      containers:
      - args:
        - --v=5
        - --leader-election
        - --leader-election-namespace=storage
        - --timeout=90s
        - --worker-threads=10
        - --csi-address=/csi-data/csi.sock
        image: registry.k8s.io/sig-storage/csi-attacher:v4.4.0
        name: external-attacher
        volumeMounts:
        - mountPath: /csi-data
          name: socket-dir
      - args:
        - --v=5
        - --leader-election
        - --leader-election-namespace=storage
        - --timeout=90s
        - --worker-threads=10
        - --extra-create-metadata
        - --csi-address=/csi-data/csi.sock
        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: spec.nodeName
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.namespace
        - name: POD_NAME
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.name
        image: registry.k8s.io/sig-storage/csi-provisioner:v3.6.0
        name: external-provisioner
        volumeMounts:
        - mountPath: /csi-data
          name: socket-dir
      - args:
        - --v=5
        - --leader-election
        - --leader-election-namespace=storage
        - --timeout=90s
        - --workers=10
        - --csi-address=/csi-data/csi.sock
        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: spec.nodeName
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.namespace
        - name: POD_NAME
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.name
        image: registry.k8s.io/sig-storage/csi-resizer:v1.9.0
        name: external-resizer
        volumeMounts:
        - mountPath: /csi-data
          name: socket-dir
      - args:
        - --v=5
        - --leader-election
        - --leader-election-namespace=storage
        - --timeout=90s
        - --worker-threads=10
        - --csi-address=/csi-data/csi.sock
        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: spec.nodeName
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.namespace
        - name: POD_NAME
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.name
        image: registry.k8s.io/sig-storage/csi-snapshotter:v8.2.1
        name: external-snapshotter
        volumeMounts:
        - mountPath: /csi-data
          name: socket-dir
      - args:
        - --csi-version=1.5.0
        - --csi-name=org.democratic-csi.iscsi
        - --driver-config-file=/config/driver-config-file.yaml
        - --log-level=debug
        - --csi-mode=controller
        - --server-socket=/csi-data/csi.sock.internal
        env:
        - name: NODE_EXTRA_CA_CERTS
          value: /tmp/certs/extra-ca-certs.crt
        image: ghcr.io/democratic-csi/democratic-csi:next
        imagePullPolicy: Always
        livenessProbe:
          exec:
            command:
            - bin/liveness-probe
            - --csi-version=1.5.0
            - --csi-address=/csi-data/csi.sock.internal
          failureThreshold: 3
          initialDelaySeconds: 10
          periodSeconds: 60
          timeoutSeconds: 15
        name: csi-driver
        volumeMounts:
        - mountPath: /csi-data
          name: socket-dir
        - mountPath: /config
          name: config
        - mountPath: /tmp/certs
          name: extra-ca-certs
      - env:
        - name: BIND_TO
          value: unix:///csi-data/csi.sock
        - name: PROXY_TO
          value: unix:///csi-data/csi.sock.internal
        image: docker.io/democraticcsi/csi-grpc-proxy:v0.5.6
        name: csi-proxy
        volumeMounts:
        - mountPath: /csi-data
          name: socket-dir
      dnsPolicy: ClusterFirst
      hostAliases: []
      hostIPC: false
      hostNetwork: false
      nodeSelector:
        kubernetes.io/os: linux
      priorityClassName: system-cluster-critical
      serviceAccount: democratic-csi-controller-sa
      volumes:
      - emptyDir: {}
        name: socket-dir
      - name: config
        secret:
          secretName: truenas-iscsi-driver-config
      - configMap:
          items:
          - key: extra-ca-certs
            path: extra-ca-certs.crt
          name: democratic-csi
        name: extra-ca-certs
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  labels:
    app.kubernetes.io/component: node-linux
    app.kubernetes.io/csi-role: node
    app.kubernetes.io/instance: democratic-csi
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: democratic-csi
    helm.sh/chart: democratic-csi-0.15.0
  name: democratic-csi-node
  namespace: storage
spec:
  selector:
    matchLabels:
      app.kubernetes.io/component: node-linux
      app.kubernetes.io/csi-role: node
      app.kubernetes.io/instance: democratic-csi
      app.kubernetes.io/managed-by: Helm
      app.kubernetes.io/name: democratic-csi
  template:
    metadata:
      annotations:
        checksum/configmap: 27d5709f6648fe2cbceee9df76c7c94b653208bff8254c4df16fd04c4ca88302
      labels:
        app.kubernetes.io/component: node-linux
        app.kubernetes.io/csi-role: node
        app.kubernetes.io/instance: democratic-csi
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/name: democratic-csi
    spec:
      containers:
      - args:
        - --csi-version=1.5.0
        - --csi-name=org.democratic-csi.iscsi
        - --driver-config-file=/config/driver-config-file.yaml
        - --log-level=info
        - --csi-mode=node
        - --server-socket=/csi-data/csi.sock.internal
        env:
        - name: CSI_NODE_ID
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: spec.nodeName
        - name: NODE_EXTRA_CA_CERTS
          value: /tmp/certs/extra-ca-certs.crt
        - name: ISCSIADM_HOST_STRATEGY
          value: nsenter
        - name: ISCSIADM_HOST_PATH
          value: /usr/local/sbin/iscsiadm
        image: ghcr.io/democratic-csi/democratic-csi:next
        imagePullPolicy: Always
        livenessProbe:
          exec:
            command:
            - bin/liveness-probe
            - --csi-version=1.5.0
            - --csi-address=/csi-data/csi.sock.internal
          failureThreshold: 3
          initialDelaySeconds: 10
          periodSeconds: 60
          timeoutSeconds: 15
        name: csi-driver
        securityContext:
          allowPrivilegeEscalation: true
          capabilities:
            add:
            - SYS_ADMIN
          privileged: true
        terminationMessagePath: /tmp/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /csi-data
          name: socket-dir
        - mountPath: /var/lib/kubelet
          mountPropagation: Bidirectional
          name: kubelet-dir
        - mountPath: /var/iscsi
          mountPropagation: Bidirectional
          name: iscsi-dir
        - mountPath: /var/lib/iscsi
          mountPropagation: Bidirectional
          name: iscsi-info
        - mountPath: /lib/modules
          name: modules-dir
          readOnly: true
        - mountPath: /etc/localtime
          name: localtime
          readOnly: true
        - mountPath: /run/udev
          name: udev-data
        - mountPath: /host
          mountPropagation: Bidirectional
          name: host-dir
        - mountPath: /sys
          name: sys-dir
        - mountPath: /dev
          name: dev-dir
        - mountPath: /config
          name: config
        - mountPath: /tmp/certs
          name: extra-ca-certs
      - env:
        - name: BIND_TO
          value: unix:///csi-data/csi.sock
        - name: PROXY_TO
          value: unix:///csi-data/csi.sock.internal
        image: docker.io/democraticcsi/csi-grpc-proxy:v0.5.6
        name: csi-proxy
        volumeMounts:
        - mountPath: /csi-data
          name: socket-dir
      - args:
        - --v=5
        - --csi-address=/csi-data/csi.sock
        - --kubelet-registration-path=/var/lib/kubelet/plugins/org.democratic-csi.iscsi/csi.sock
        env:
        - name: KUBE_NODE_NAME
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: spec.nodeName
        image: registry.k8s.io/sig-storage/csi-node-driver-registrar:v2.9.0
        livenessProbe:
          exec:
            command:
            - /csi-node-driver-registrar
            - --kubelet-registration-path=/var/lib/kubelet/plugins/org.democratic-csi.iscsi/csi.sock
            - --mode=kubelet-registration-probe
        name: driver-registrar
        volumeMounts:
        - mountPath: /csi-data
          name: socket-dir
        - mountPath: /registration
          name: registration-dir
        - mountPath: /var/lib/kubelet
          name: kubelet-dir
      - args:
        - while true; do sleep 2; done;
        command:
        - /bin/sh
        - -c
        - --
        image: docker.io/busybox:1.37.0
        lifecycle:
          preStop:
            exec:
              command:
              - /bin/sh
              - -c
              - rm -rf /plugins/org.democratic-csi.iscsi /registration/org.democratic-csi.iscsi-reg.sock
        name: cleanup
        volumeMounts:
        - mountPath: /plugins
          name: plugins-dir
        - mountPath: /registration
          name: registration-dir
      dnsPolicy: ClusterFirstWithHostNet
      hostAliases: []
      hostIPC: true
      hostNetwork: true
      hostPID: true
      nodeSelector:
        kubernetes.io/os: linux
      priorityClassName: system-node-critical
      serviceAccount: democratic-csi-node-sa
      volumes:
      - hostPath:
          path: /var/lib/kubelet/plugins/org.democratic-csi.iscsi
          type: DirectoryOrCreate
        name: socket-dir
      - hostPath:
          path: /var/lib/kubelet/plugins
          type: Directory
        name: plugins-dir
      - hostPath:
          path: /var/lib/kubelet/plugins_registry
          type: Directory
        name: registration-dir
      - hostPath:
          path: /var/lib/kubelet
          type: Directory
        name: kubelet-dir
      - hostPath:
          path: /var/iscsi
          type: null
        name: iscsi-dir
      - hostPath:
          path: /var/lib/iscsi
        name: iscsi-info
      - hostPath:
          path: /dev
          type: Directory
        name: dev-dir
      - hostPath:
          path: /lib/modules
        name: modules-dir
      - hostPath:
          path: /etc/localtime
        name: localtime
      - hostPath:
          path: /run/udev
        name: udev-data
      - hostPath:
          path: /sys
          type: Directory
        name: sys-dir
      - hostPath:
          path: /
          type: Directory
        name: host-dir
      - name: config
        secret:
          secretName: truenas-iscsi-driver-config
      - configMap:
          items:
          - key: extra-ca-certs
            path: extra-ca-certs.crt
          name: democratic-csi
        name: extra-ca-certs
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: truenas-iscsi-driver-config
  namespace: storage
spec:
  data:
  - remoteRef:
      key: TRUENAS_IP
    secretKey: TRUENAS_IP
  - remoteRef:
      key: TRUENAS_API_KEY
    secretKey: TRUENAS_API_KEY
  secretStoreRef:
    kind: ClusterSecretStore
    name: doppler
  target:
    name: truenas-iscsi-driver-config
    template:
      data:
        driver-config-file.yaml: |
          driver: freenas-api-iscsi
          httpConnection:
            protocol: http
            host: '{{ .TRUENAS_IP }}'
            port: 80
            apiKey: '{{ .TRUENAS_API_KEY }}'
            allowInsecure: true
          zfs:
            datasetParentName: mongo/k8s/iscsi/v
            detachedSnapshotsDatasetParentName: mongo/k8s/iscsi/s
            zvolEnableReservation: false
            zvolDedup: "off"
          iscsi:
            targetPortal: '{{ .TRUENAS_IP }}:3260'
            targetPortals: []
            namePrefix: csi-
            nameSuffix: -cosmere
            targetGroups:
              - targetGroupPortalGroup: 1
                targetGroupInitiatorGroup: 1
                targetGroupAuthType: None
            extentInsecureTpc: true
            extentXenCompat: false
            extentDisablePhysicalBlocksize: true
            extentBlocksize: 512
            extentRpm: SSD
            extentAvailThreshold: 0
      engineVersion: v2
---
apiVersion: snapshot.storage.k8s.io/v1
deletionPolicy: Delete
driver: org.democratic-csi.iscsi
kind: VolumeSnapshotClass
metadata:
  labels:
    app.kubernetes.io/instance: democratic-csi
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: democratic-csi
    helm.sh/chart: democratic-csi-0.15.0
  name: org.democratic-csi.iscsi
  namespace: storage
parameters:
  detachedSnapshots: "true"
---
apiVersion: storage.k8s.io/v1
kind: CSIDriver
metadata:
  labels:
    app.kubernetes.io/instance: democratic-csi
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: democratic-csi
    helm.sh/chart: democratic-csi-0.15.0
  name: org.democratic-csi.iscsi
spec:
  attachRequired: true
  podInfoOnMount: true
